<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>خريطة ArcGIS - بسيطة وتعمل</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>
  <style>
    html, body, #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <!-- شاشة إدخال كلمة المرور -->
  <div id="passwordScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; color: #fff; display: flex; align-items: center; justify-content: center; z-index: 9999;">
      <div style="text-align: center; padding: 20px; background: #333; border-radius: 10px;">
          <h2>أدخل كلمة المرور للوصول</h2>
          <input type="password" id="passwordInput" placeholder="كلمة المرور" style="padding: 10px; margin: 10px; width: 200px;">
          <br>
          <button onclick="checkPassword()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">دخول</button>
          <p id="errorMsg" style="color: red; display: none;">كلمة المرور غير صحيحة!</p>
      </div>
  </div>

  <!-- المحتوى الرئيسي -->
  <div id="mainContent" style="display: none;">
      <div id="viewDiv"></div>
  </div>

  <!-- سكريبت التحقق من كلمة المرور -->
  <script>
      const correctPassword = "mypassword"; // غيّر هذه الكلمة إلى ما تريد (مثال: "newpass123")
      let mapLoaded = false; // لتجنب إعادة التحميل

      function checkPassword() {
          const input = document.getElementById('passwordInput').value;
          const errorMsg = document.getElementById('errorMsg');
         
          if (input === correctPassword) {
              document.getElementById('passwordScreen').style.display = 'none';
              document.getElementById('mainContent').style.display = 'block';
              // حفظ في sessionStorage لتجنب إعادة الإدخال في نفس الجلسة
              sessionStorage.setItem('passwordEntered', 'true');
              
              // تحميل الخريطة بعد إظهار المحتوى
              if (!mapLoaded) {
                  initMap();
                  mapLoaded = true;
              }
          } else {
              errorMsg.style.display = 'block';
              setTimeout(() => { errorMsg.style.display = 'none'; }, 3000);
          }
      }
      
      // التحقق إذا تم إدخال كلمة المرور سابقًا في الجلسة
      if (sessionStorage.getItem('passwordEntered') === 'true') {
          document.getElementById('passwordScreen').style.display = 'none';
          document.getElementById('mainContent').style.display = 'block';
          if (!mapLoaded) {
              initMap();
              mapLoaded = true;
          }
      }
      
      // السماح بالدخول بالضغط على Enter
      document.getElementById('passwordInput').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
              checkPassword();
          }
      });

      // دالة تحميل الخريطة
      function initMap() {
          require([
              "esri/views/MapView",
              "esri/WebMap",
              "esri/widgets/Search",
              "esri/widgets/LayerList",
              "esri/widgets/Sketch",
              "esri/layers/GraphicsLayer"
          ], function(MapView, WebMap, Search, LayerList, Sketch, GraphicsLayer) {
              // تحميل الخريطة من ArcGIS Online
              const webmap = new WebMap({
                  portalItem: {
                      id: "310a31d8e76040258fc9309c473cb1f9"
                  }
              });
              const view = new MapView({
                  container: "viewDiv",
                  map: webmap
              });
              // --- البحث ---
              view.when(() => {
                  const targetLayer = webmap.layers.find(layer =>
                      layer.title.includes("الرقم الموحد") ||
                      layer.title.includes("Unified") ||
                      layer.title.includes("parcel")
                  );
                  if (!targetLayer) {
                      console.warn("لم يتم العثور على الطبقة المناسبة للبحث.");
                  }
                  const searchWidget = new Search({
                      view: view,
                      includeDefaultSources: false,
                      sources: targetLayer ? [{
                          layer: targetLayer,
                          searchFields: ["رقم_موحد", "unified_id", "parcel_no"],
                          displayField: "رقم_موحد",
                          exactMatch: false,
                          outFields: ["*"],
                          name: "البحث حسب الرقم الموحد",
                          placeholder: "أدخل الرقم الموحد"
                      }] : []
                  });
                  searchWidget.on("select-result", function(event) {
                      if (event.result && event.result.feature) {
                          view.goTo(event.result.feature.geometry);
                      }
                  });
                  view.ui.add(searchWidget, { position: "top-right" });
                  // --- التحكم بالطبقات ---
                  const layerList = new LayerList({ view: view });
                  view.ui.add(layerList, { position: "top-right" });
                  // --- أداة الرسم ---
                  const graphicsLayer = new GraphicsLayer();
                  view.map.add(graphicsLayer);
                  const sketch = new Sketch({
                      layer: graphicsLayer,
                      view: view,
                      creationMode: "update"
                  });
                  view.ui.add(sketch, "top-left");
              }).catch(function(error) {
                  console.error("خطأ في تحميل الخريطة:", error);
                  // عرض رسالة خطأ بسيطة في الصفحة للاختبار
                  document.getElementById('viewDiv').innerHTML = '<div style="padding: 20px; text-align: center; color: red;">خطأ في تحميل الخريطة: ' + error.message + '. تحقق من الاتصال بالإنترنت أو صلاحيات الخريطة.</div>';
              });
          });
      }
  </script>
</body>
</html>
